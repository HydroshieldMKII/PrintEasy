<div class="card p-4">
  <div class="flex justify-between items-center">
    <h1 class="text-4xl font-bold">Offers</h1>
  </div>

  <p-toast></p-toast>

  <p-tabs [(value)]="activeTab">
    <p-tablist>
      <p-tab value="all" (click)="onTabChange('all')">Offer received</p-tab>
      <p-tab value="mine" (click)="onTabChange('mine')">My pending offer</p-tab>
    </p-tablist>

    <p-tabpanels>
      <p-tabpanel *ngFor="let tab of ['all', 'mine']" [value]="tab">
        <!-- Directly iterate through the native API structure -->
        <div *ngFor="let request of currentRequests" class="mb-6">
          <div class="request-header p-2 bg-gray-100 rounded">
            <a style="color: black;" [routerLink]="activeTab === 'all' ? ['/requests/edit/', request.id] : ['/requests/view/', request.id]">
              <h2 class="text-xl">
                <span class="font-bold">{{ request.name }}</span> •
                {{ request.budget | currency }} •
                {{ request.targetDate | date:'mediumDate' }}
              </h2>
            </a>
          </div>

          <p-table [value]="request.offers" dataKey="id" styleClass="fixed-table">
            <ng-container *ngIf="activeTab === 'all'; else mineColGroup">
              <ng-template pTemplate="colgroup">
                <col style="width: 14.28%;" />
                <col style="width: 14.28%;" />
                <col style="width: 14.28%;" />
                <col style="width: 14.28%;" />
                <col style="width: 14.28%;" />
                <col style="width: 14.28%;" />
                <col style="width: 14.28%;" />
              </ng-template>
            </ng-container>
            <ng-template #mineColGroup>
              <ng-template pTemplate="colgroup">
                <col style="width: 16.66%;" />
                <col style="width: 16.66%;" />
                <col style="width: 16.66%;" />
                <col style="width: 16.66%;" />
                <col style="width: 16.66%;" />
                <col style="width: 16.66%;" />
              </ng-template>
            </ng-template>
          
            <ng-template pTemplate="header">
              <tr>
                <th *ngIf="activeTab === 'all'">Username</th>
                <th>Printer</th>
                <th>Preset</th>
                <th>Price Offered</th>
                <th>Offer Date</th>
                <th>Cancelled</th>
                <th>Actions</th>
              </tr>
            </ng-template>
          
            <ng-template pTemplate="body" let-offer>
              <tr>
                <td *ngIf="activeTab === 'all'">{{ offer.printer_user.user.username }}</td>
                <td>{{ offer.printer_user.printer.model }}</td>
                <td>{{ offer.color.name }} / {{ offer.filament.name }} / {{ offer.print_quality }}mm</td>
                <td>{{ offer.price === 0 ? 'Free' : (offer.price | currency) }}</td>
                <td>{{ offer.target_date | date:'mediumDate' }}</td>
                <td>{{ offer.cancelled_at ? 'Yes' : 'No' }}</td>
                <td>
                  <button pButton type="button" icon="pi pi-pencil" title="Edit this offer" 
                          (click)="editOffer(offer)" *ngIf="activeTab === 'mine'"></button>
                  <button pButton type="button" icon="pi pi-times" title="Cancel this offer" severity="danger" 
                          (click)="cancelOffer(offer, request)" *ngIf="activeTab === 'mine'"></button>
                  <button pButton type="button" icon="pi pi-check" title="Accept this offer" severity="success" 
                          (click)="showAcceptOffer(offer)" *ngIf="activeTab === 'all'"></button>
                  <button pButton type="button" icon="pi pi-times" title="Refuse this offer" severity="danger" 
                          (click)="showRefuseOffer(offer)" *ngIf="activeTab === 'all'"></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
          
          
          
        </div>

        <div *ngIf="activeTab == 'all' && !isOwningPrinter" class="empty-message" style="width: 100%; height: 100%;">
          <!-- Optionally display a message if no printer is available -->
        </div>

        <div *ngIf="(currentRequests.length === 0)" class="empty-message">
          <i class="pi pi-inbox text-6xl text-gray-400"></i>
          <p class="text-xl font-semibold text-gray-500 mt-2">
            Nothing to show here.
          </p>
        </div>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</div>

<!-- Cancel Confirmation Dialog -->
<p-dialog
  [(visible)]="deleteDialogVisible"
  [modal]="true"
  [style]="{ width: '25rem' }"
  dismissableMask="true"
  closable="false"
  blockScroll="true"
  resizable="false"
  draggable="false"
>
  <ng-template #header>
    <div class="inline-flex items-center justify-center gap-2">
      <i class="pi pi-exclamation-triangle text-red-500 text-2xl"></i>
      <span class="font-bold">Confirm Cancel</span>
    </div>
  </ng-template>
  <span class="text-surface-500 dark:text-surface-400 block mb-4">
    Are you sure you want to cancel your offer for {{ requestToDelete?.name }} with your {{ offerToDelete?.printer_user.printer.model }}?
    This action cannot be undone.
  </span>
  <ng-template #footer>
    <p-button label="No"  severity="secondary" (click)="deleteDialogVisible = false"/>
    <p-button label="Yes" severity="danger" (click)="confirmDelete()" />
  </ng-template>
</p-dialog>

<!-- Refuse Confirmation Dialog -->
<p-dialog
  [(visible)]="refuseDialogVisible"
  [modal]="true"
  [style]="{ width: '25rem' }"
  dismissableMask="true"
  closable="false"
  blockScroll="true"
  resizable="false"
  draggable="false"
>
  <ng-template #header>
    <div class="inline-flex items-center justify-center gap-2">
      <i class="pi pi-exclamation-triangle text-red-500 text-2xl"></i>
      <span class="font-bold">Confirm Refuse</span>
    </div>
  </ng-template>
  <span class="text-surface-500 dark:text-surface-400 block mb-4">
    Are you sure you want to refuse the offer from {{ offerToRefuse?.printer_user.user.username }}?
    This action cannot be undone.
  </span>
  <ng-template #footer>
    <p-button label="No" severity="secondary" (click)="refuseDialogVisible = false" />
    <p-button label="Yes" severity="danger" (click)="confirmRefuse()" />
  </ng-template>
</p-dialog>

<app-offer-modal *ngIf="offerModalVisible" [(offerModalVisible)]="offerModalVisible" [offerIdToEdit]="offerIdToEdit" (offerUpdated)="onOfferUpdated($event)"></app-offer-modal>
