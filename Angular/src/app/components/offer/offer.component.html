<div class="card p-4">
    <div class="flex justify-between items-center">
      <h1 class="text-4xl font-bold">Offers</h1>
    </div>
  
    <p-toast />
  
    <p-tabs [(value)]="activeTab">
      <p-tablist>
        <p-tab value="all" (click)="onTabChange('all')">Offer received</p-tab>
        <p-tab value="mine" (click)="onTabChange('mine')">My pending offer</p-tab>
      </p-tablist>
  
      <p-tabpanels>
        <p-tabpanel *ngFor="let tab of ['all', 'mine']" [value]="tab">  
            <p-table
            *ngIf="currentOffers.length > 0 || activeTab == 'mine'"
            [value]="currentOffers"
            dataKey="id"
            [expandedRowKeys]="expandedRowKeys"
            (onRowExpand)="onRowExpand($event)"
            (onRowCollapse)="onRowCollapse($event)"
          >
        
            <ng-template #header>
              <tr>
                <th style="width: 5rem"></th>
                <th >Name </th>
                <th >
                  Price
                </th>
                <th >
                  Target Date
                </th>
                <th >
                  Country
                </th>
                <th style="width: 4rem">Actions</th>
              </tr>
            </ng-template>
  
            <ng-template #body let-offer let-expanded="expanded">
              <tr>
                <td>
                  <p-button
                    type="button"
                    [pRowToggler]="offer"
                    [text]="true"
                    [rounded]="true"
                    [plain]="true"
                    [icon]="
                      expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'
                    "
                  />
                </td>
                <td>{{offer.request.name}}</td>
                <td>{{offer.request.budget | currency}}</td>
                <td>{{offer.request.target_date}}</td>
                <td>{{offer.printer_user.user.country}}</td>
                <td>
                  <div class="flex gap-2">
                    <p-button
                    icon="pi pi-arrow-right"
                    title="See Details"
                    routerLink="/requests/view/{{ offer.request.id }}"
                    *ngIf="tab === 'mine'"
                  ></p-button>
                    <p-button
                    icon="pi pi-share-alt"
                    title="Share"
                    (click)="copyToClipboard('requests/view/' + offer.id)"
                  ></p-button>
                  <p-button
                  *ngIf="tab === 'mine'"
                  icon="pi pi-trash"
                  severity="danger"
                  title="Delete all offers for this request"
                  (onClick)="showDeleteDialog(offer)"
                ></p-button>
                  </div>
                </td>
              </tr>
            </ng-template>
  
            <ng-template #expandedrow let-offer>
              <tr>
                <td colspan="7" style="background-color: #f5f5f5">
                  <div>
                    <h3>{{activeTab == 'mine' ? 'My offer details' : 'Offer details'}}</h3>
                    <p-table
                      [value]="[offer]"
                      dataKey="id"
                    >
                    <ng-template #header>
                      <tr>
                        <th *ngIf="activeTab == 'all'">User</th>
                        <th>Printer</th>
                        <th>Filament</th>
                        <th>Color</th>
                        <th>Quality</th>
                        <th>Price offered</th>
                        <th>Date offered</th>
                        <th>Actions</th>
                      </tr>
                    </ng-template>
                    <ng-template #body let-offer>
                      <tr>
                        <td *ngIf="activeTab == 'all'">
                          {{ offer.printer_user.user.username }}<br>
                          {{ offer.printer_user.user.country }}
                        </td>
                        <td>
                          {{ offer.printer_user.printer.model }}<br>
                          <span class="text-gray-500">Acquired on {{ offer.printer_user.aquired_date | date:'mediumDate' }}</span>
                        </td>
                        <td>{{offer.color.name}}</td>
                        <td>{{ offer.filament.name }}</td>
                        <td>{{ offer.print_quality }}mm</td>
                        <td>{{offer.price | currency}}</td>
                        <td>{{offer.target_date}}</td>
                        <td>
                          <div class="flex gap-2">
                            <button
                            pButton
                            type="button"
                            icon="pi pi-pencil"
                            title="Edit this offer"
                            (click)="editOffer(offer)"
                          ></button>
                          <button
                            pButton
                            type="button"
                            icon="pi pi-times"
                            title="Cancel this offer"
                            (click)="cancelOffer(offer)"
                          ></button>
                          </div>
                        </td>                        
                      </tr>
                    </ng-template>
                    
                    </p-table>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
  
          <div
            *ngIf="activeTab == 'all' && !isOwningPrinter"
            class="empty-message"
            style="width: 100%; height: 100%;"
          >
            <i class="pi pi-inbox text-6xl text-gray-400"></i>
            <p class="text-xl font-semibold text-gray-500 mt-2" *ngIf="!isOwningPrinter">
              You dont have a printer! Add one to see people's requests and
              contribute to the community.
            </p>
          </div>
  
          <div
            *ngIf="
              (isOwningPrinter && currentOffers.length === 0) ||
              (activeTab == 'my' && currentOffers.length === 0)
            "
            class="empty-message"
          >
            <i class="pi pi-inbox text-6xl text-gray-400"></i>
            <p class="text-xl font-semibold text-gray-500 mt-2">
              Nothing to show here.
            </p>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>
  
  <!-- Delete Confirmation Dialog -->
  <p-dialog
    [(visible)]="deleteDialogVisible"
    [modal]="true"
    [style]="{ width: '25rem' }"
    dismissableMask="true"
    closable="false"
    blockScroll="true"
    resizable="false"
    draggable="false"
  >
    <ng-template #header>
      <div class="inline-flex items-center justify-center gap-2">
        <i class="pi pi-exclamation-triangle text-red-500 text-2xl"></i>
        <span class="font-bold">Confirm Delete</span>
      </div>
    </ng-template>
    <span class="text-surface-500 dark:text-surface-400 block mb-4">
      Are you sure you want to delete this offer?
      This action cannot be undone.
    </span>
    <ng-template #footer>
      <p-button
        label="Cancel"
        [text]="true"
        severity="secondary"
        (click)="deleteDialogVisible = false"
      />
      <p-button label="Delete" severity="danger" (click)="confirmDelete()" />
    </ng-template>
  </p-dialog>
  