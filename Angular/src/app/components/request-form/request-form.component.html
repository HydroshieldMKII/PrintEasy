<div class="card p-6">
  <h1>
    {{ isEditMode ? "Edit Request" : "Request Details" }}
  </h1>

  <!-- Use *ngIf to avoid rendering before form is defined -->
  <form *ngIf="form" [formGroup]="form" (ngSubmit)="submitRequest()">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Left Section: Request Details -->
      <div class="flex flex-col">
        <div class="form-field">
          <p-floatlabel variant="in" floatLabel="always">
            <input
              id="name"
              pInputText
              formControlName="name"
              class="w-full"
              minlength="3"
              maxlength="30"
            />
            <label for="name">Name</label>
          </p-floatlabel>

          <p-message
            *ngIf="form.get('name')?.errors?.['required'] && (form.get('name')?.dirty || form.get('name')?.touched)"
            severity="error"
            variant="simple"
            size="small"
          >
            Name is required
          </p-message>

          <p-message
            *ngIf="!form.get('name')?.errors?.['required'] && form.get('name')?.errors?.['minlength'] && (form.get('name')?.dirty || form.get('name')?.touched)"
            severity="error"
            variant="simple"
            size="small"
          >
            Name must be at least 3 characters long
          </p-message>
        </div>

        <div class="form-field">
          <p-floatlabel variant="in">
            <p-inputnumber
              formControlName="budget"
              [min]="0"
              [max]="10000"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              prefix="$"
              class="w-full"
              placeholder="Budget"
            ></p-inputnumber>
            <label for="budget" class="block font-semibold">Budget</label>
          </p-floatlabel>
          

          <p-message
            *ngIf="form.get('budget')?.errors?.['required'] && (form.get('budget')?.dirty || form.get('budget')?.touched)"
            severity="error"
            variant="simple"
            size="small"
          >
            Budget is required
          </p-message>
          <p-message
            *ngIf="!form.get('budget')?.errors?.['required'] && form.get('budget')?.errors?.['min'] && (form.get('budget')?.dirty || form.get('budget')?.touched)"
            severity="error"
            variant="simple"
            size="small"
          >
            Budget must be at least 0
          </p-message>
          <p-message
            *ngIf="!form.get('budget')?.errors?.['required'] && form.get('budget')?.errors?.['max'] && (form.get('budget')?.dirty || form.get('budget')?.touched)"
            severity="error"
            variant="simple"
            size="small"
          >
            Budget must be at most 10000
          </p-message>
        </div>

        <p-floatlabel variant="in">
          <textarea
            pTextarea
            id="comment"
            formControlName="comment"
            rows="5"
            cols="30"
            maxlength="200"
          ></textarea>
          <label for="comment">Special comment about the request</label>
        </p-floatlabel>

        <div class="form-field">
          <p-floatlabel variant="in">
            <div class="w-full">
                <p-datepicker
                id="targetDate"
                formControlName="targetDate"
                [showIcon]="true"
                inputId="buttondisplay"
                [showOnFocus]="false"
                styleClass="date-picker-full-on-mobile"
                dateFormat="yy-mm-dd"
              ></p-datepicker>
              <label for="targetDate" class="block font-semibold">Target Date</label>
            </div>
          </p-floatlabel>
          <p-message
            *ngIf="form.get('targetDate')?.errors?.['required'] && (form.get('targetDate')?.dirty || form.get('targetDate')?.touched)"
            severity="error"
            variant="simple"
            size="small"
          >
            Target Date is required
          </p-message>
          <p-message
            *ngIf="!form.get('targetDate')?.errors?.['required'] && form.get('targetDate')?.errors?.['dateError'] && (form.get('targetDate')?.dirty || form.get('targetDate')?.touched)"
            severity="error"
            variant="simple"
            size="small"
          >
            Target Date should be later than today
          </p-message>
        </div>
      </div>

      <!-- Right Section: STL Preview -->
      <div class="stl-section flex flex-col items-center">
        <div class="stl-placeholder">
          <p-message
            *ngIf="!request.stlFileUrl && !uploadedFileBlob"
            severity="warn"
            text="No STL file uploaded"
          ></p-message>
          <stl-model-viewer
            *ngIf="!uploadedFileBlob && (isEditMode || isViewMode) && request.stlFileUrl"
            [stlModels]="[request.stlFileUrl]"
          ></stl-model-viewer>
          <stl-model-viewer
            *ngIf="uploadedFileBlob && (isEditMode || isNewMode)"
            [stlModelFiles]="[uploadedFileBlob]"
          ></stl-model-viewer>
        </div>

        <div class="stl-actions flex gap-2 mt-4">
          <p-button
            *ngIf="isViewMode"
            label="Download file"
            icon="pi pi-download"
            class="p-button-outlined flex-1"
            (onClick)="downloadFile(request.stlFileUrl)"
          ></p-button>
          <p-fileUpload
            *ngIf="(isEditMode || isNewMode) && !request.hasOffers"
            mode="basic"
            maxFileSize="10000000"
            invalidFileSizeMessageDetail="File size is too large. Max 10MB"
            invalidFileTypeMessageDetail="File type is not supported. Please upload a .stl file"
            customUpload="false"
            (onSelect)="onFileUpload($event)"
            accept=".stl"
            chooseLabel="Upload file"
            class="flex-1"
          ></p-fileUpload>
        </div>
      </div>
    </div>

    <!-- Presets Section -->
    <div class="flex justify-between items-center mt-6">
      <h3 class="text-lg font-semibold self-center mr-2">
        {{ request.presets.length }} Preset(s) recommended
      </h3>
      <p-button
        id="add-preset"
        *ngIf="(isEditMode || isNewMode) && !request.hasOffers"
        label="Add preset"
        [link]="true"
        icon="pi pi-plus"
        (click)="addPreset()"
      ></p-button>
      <p *ngIf="isEditMode && request.hasOffers" style="color: red;">
        You can't edit the presets and file. Offers have been made.
      </p>
    </div>

    <button type="submit" style="display: none;"></button>
  </form>

  <!-- Presets Table (outside the form) -->
  <p-table
    [value]="request.presets"
    dataKey="id"
    [tableStyle]="{ 'min-width': '50rem' }"
    *ngIf="request.presets.length > 0"
  >
    <ng-template #header>
      <tr>
        <th>Printer</th>
        <th>Filament Type</th>
        <th>Color</th>
        <th>Print Quality (mm)</th>
        <th style="width: 25%;">Action(s)</th>
      </tr>
    </ng-template>
    <ng-template #body let-preset let-ri="rowIndex">
      <tr [ngClass]="{ 'invalid': !isPresetValid(preset) }">
        <td>
          <p-dropdown
            [(ngModel)]="preset.printerModel.model"
            [options]="printers"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Printer"
            [disabled]="isViewMode || request.hasOffers"
            appendTo="body"
          ></p-dropdown>
        </td>
        <td>
          <p-dropdown
            [(ngModel)]="preset.filamentType.name"
            [options]="filamentTypes"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Filament"
            [disabled]="isViewMode || request.hasOffers"
            appendTo="body"
          ></p-dropdown>
        </td>
        <td>
          <p-dropdown
            [(ngModel)]="preset.color.name"
            [options]="colors"
            optionLabel="label"
            optionValue="value"
            placeholder="Select Color"
            [disabled]="isViewMode || request.hasOffers"
            appendTo="body"
          ></p-dropdown>
        </td>
        <td>
          <p-inputnumber 
            [showButtons]="isEditMode || isNewMode" 
            buttonLayout="horizontal" 
            spinnerMode="vertical" 
            inputId="vertical" 
            [inputStyle]="{ width: '4rem' }" 
            [(ngModel)]="preset.printQuality" 
            [step]="0.04" 
            [min]="0.01" 
            [max]="2"
            [disabled]="isViewMode || request.hasOffers"
          ></p-inputnumber>
        </td>
        <td *ngIf="isEditMode || isNewMode">
          <button
            pButton
            pRipple
            type="button"
            icon="pi pi-trash"
            class="p-button-rounded p-button-danger"
            (click)="removePreset(ri)"
            severity="danger"
            appendTo="body"
            [disabled]="request.hasOffers"
          ></button>
        </td>
        <td *ngIf="isViewMode">
          <button
            pButton
            pRipple
            type="button"
            icon="pi pi-arrow-right"
            class="p-button-rounded p-button-info"
            label="Offer this preset"
          ></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <div class="flex justify-end mt-6 gap-3 edit-actions" *ngIf="isViewMode">
    <p-button
      type="button"
      label="Make an offer"
      icon="pi pi-money-bill"
      severity="info"
      (click)="showOfferModal()"
    ></p-button>
  </div>

      <!-- Action Buttons -->
      <div class="flex justify-end mt-6 gap-3 edit-actions" *ngIf="isEditMode || isNewMode">
        <p-button
          type="button"
          label="Cancel"
          icon="pi pi-times"
          severity="secondary"
          (click)="isEditMode ? cancelEdit() : cancelNew()"
        ></p-button>
        <p-button
          *ngIf="isEditMode"
          type="button"
          label="Delete"
          icon="pi pi-trash"
          severity="danger"
          (click)="showDeleteDialog(request)"
          [disabled]="request.hasOfferAccepted"
        ></p-button>
        <p-button
          (onClick)="submitRequest()"
          label="Save"
          icon="pi pi-save"
          severity="success"
          id="save-button"
          [disabled]="form.invalid || (isNewMode && !uploadedFile) || request.hasOfferAccepted"
        ></p-button>
      </div>

  <!-- Delete Confirmation Dialog -->
  <p-dialog
    [(visible)]="deleteDialogVisible"
    [modal]="true"
    [style]="{ width: '25rem' }"
    dismissableMask="true"
    closable="false"
    blockScroll="true"
    resizable="false"
    draggable="false"
  >
    <ng-template #header>
      <div class="inline-flex items-center justify-center gap-2">
        <i class="pi pi-exclamation-triangle text-red-500 text-2xl"></i>
        <span class="font-bold">Confirm Delete</span>
      </div>
    </ng-template>
    <span class="text-surface-500 dark:text-surface-400 block mb-4">
      Are you sure you want to delete the request "{{ requestToDelete?.name }}"?
      This action cannot be undone.
    </span>
    <ng-template #footer>
      <p-button
        label="Cancel"
        [text]="true"
        severity="secondary"
        (click)="deleteDialogVisible = false"
      ></p-button>
      <p-button label="Delete" severity="danger" (click)="confirmDelete()"></p-button>
    </ng-template>
  </p-dialog>
</div>

<app-offer-modal *ngIf="offerModalVisible" [(offerModalVisible)]="offerModalVisible"></app-offer-modal>




